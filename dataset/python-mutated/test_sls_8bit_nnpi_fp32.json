[
    {
        "func_name": "test_slws_fused_8bit_rowwise_acc32_nnpi",
        "original": "@given(seed=st.integers(0, 65535), num_rows=st.integers(2, 20), embedding_dim=st.sampled_from([8, 12, 16, 24, 32, 54, 64, 128]), batch_size=st.integers(1, 5), max_weight=st.integers(0, 100))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_slws_fused_8bit_rowwise_acc32_nnpi(self, seed, num_rows, embedding_dim, batch_size, max_weight):\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    workspace.ResetWorkspace()\n    np.random.seed(seed)\n    data = np.random.rand(num_rows, embedding_dim).astype(np.float32)\n    lengths = np.random.choice(np.arange(1, num_rows), batch_size).astype(np.int32)\n    _indices = []\n    for length in lengths:\n        _indices.extend(np.random.choice(np.arange(1, num_rows), length))\n    indices = np.asarray(_indices).astype(np.int64)\n    weights = np.random.uniform(low=0, high=max_weight, size=[len(indices)]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=batch_size, max_seq_size=np.max(lengths), debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        print_test_debug_info('test_slws_fused_8bit_rowwise_acc32_nnpi', {'seed': seed, 'num_rows': num_rows, 'embedding_dim': embedding_dim, 'batch_size': batch_size, 'indices': indices, 'data': data.shape, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
        "mutated": [
            "@given(seed=st.integers(0, 65535), num_rows=st.integers(2, 20), embedding_dim=st.sampled_from([8, 12, 16, 24, 32, 54, 64, 128]), batch_size=st.integers(1, 5), max_weight=st.integers(0, 100))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_slws_fused_8bit_rowwise_acc32_nnpi(self, seed, num_rows, embedding_dim, batch_size, max_weight):\n    if False:\n        i = 10\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    workspace.ResetWorkspace()\n    np.random.seed(seed)\n    data = np.random.rand(num_rows, embedding_dim).astype(np.float32)\n    lengths = np.random.choice(np.arange(1, num_rows), batch_size).astype(np.int32)\n    _indices = []\n    for length in lengths:\n        _indices.extend(np.random.choice(np.arange(1, num_rows), length))\n    indices = np.asarray(_indices).astype(np.int64)\n    weights = np.random.uniform(low=0, high=max_weight, size=[len(indices)]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=batch_size, max_seq_size=np.max(lengths), debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        print_test_debug_info('test_slws_fused_8bit_rowwise_acc32_nnpi', {'seed': seed, 'num_rows': num_rows, 'embedding_dim': embedding_dim, 'batch_size': batch_size, 'indices': indices, 'data': data.shape, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535), num_rows=st.integers(2, 20), embedding_dim=st.sampled_from([8, 12, 16, 24, 32, 54, 64, 128]), batch_size=st.integers(1, 5), max_weight=st.integers(0, 100))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_slws_fused_8bit_rowwise_acc32_nnpi(self, seed, num_rows, embedding_dim, batch_size, max_weight):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    workspace.ResetWorkspace()\n    np.random.seed(seed)\n    data = np.random.rand(num_rows, embedding_dim).astype(np.float32)\n    lengths = np.random.choice(np.arange(1, num_rows), batch_size).astype(np.int32)\n    _indices = []\n    for length in lengths:\n        _indices.extend(np.random.choice(np.arange(1, num_rows), length))\n    indices = np.asarray(_indices).astype(np.int64)\n    weights = np.random.uniform(low=0, high=max_weight, size=[len(indices)]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=batch_size, max_seq_size=np.max(lengths), debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        print_test_debug_info('test_slws_fused_8bit_rowwise_acc32_nnpi', {'seed': seed, 'num_rows': num_rows, 'embedding_dim': embedding_dim, 'batch_size': batch_size, 'indices': indices, 'data': data.shape, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535), num_rows=st.integers(2, 20), embedding_dim=st.sampled_from([8, 12, 16, 24, 32, 54, 64, 128]), batch_size=st.integers(1, 5), max_weight=st.integers(0, 100))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_slws_fused_8bit_rowwise_acc32_nnpi(self, seed, num_rows, embedding_dim, batch_size, max_weight):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n        n = 10\n        dp = [0, 1]\n        for i in range(2, n + 1):\n            dp.append(dp[i - 1] + dp[i - 2])\n        print(dp[n])\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    workspace.ResetWorkspace()\n    np.random.seed(seed)\n    data = np.random.rand(num_rows, embedding_dim).astype(np.float32)\n    lengths = np.random.choice(np.arange(1, num_rows), batch_size).astype(np.int32)\n    _indices = []\n    for length in lengths:\n        _indices.extend(np.random.choice(np.arange(1, num_rows), length))\n    indices = np.asarray(_indices).astype(np.int64)\n    weights = np.random.uniform(low=0, high=max_weight, size=[len(indices)]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=batch_size, max_seq_size=np.max(lengths), debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        print_test_debug_info('test_slws_fused_8bit_rowwise_acc32_nnpi', {'seed': seed, 'num_rows': num_rows, 'embedding_dim': embedding_dim, 'batch_size': batch_size, 'indices': indices, 'data': data.shape, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535), num_rows=st.integers(2, 20), embedding_dim=st.sampled_from([8, 12, 16, 24, 32, 54, 64, 128]), batch_size=st.integers(1, 5), max_weight=st.integers(0, 100))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_slws_fused_8bit_rowwise_acc32_nnpi(self, seed, num_rows, embedding_dim, batch_size, max_weight):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n        n = 10\n        dp = [0, 1]\n        for i in range(2, n + 1):\n            dp.append(dp[i - 1] + dp[i - 2])\n        print(dp[n])\n\n        def dfs(node):\n            if node == None:\n                return []\n            left = dfs(node.left)\n            right = dfs(node.right)\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    workspace.ResetWorkspace()\n    np.random.seed(seed)\n    data = np.random.rand(num_rows, embedding_dim).astype(np.float32)\n    lengths = np.random.choice(np.arange(1, num_rows), batch_size).astype(np.int32)\n    _indices = []\n    for length in lengths:\n        _indices.extend(np.random.choice(np.arange(1, num_rows), length))\n    indices = np.asarray(_indices).astype(np.int64)\n    weights = np.random.uniform(low=0, high=max_weight, size=[len(indices)]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=batch_size, max_seq_size=np.max(lengths), debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        print_test_debug_info('test_slws_fused_8bit_rowwise_acc32_nnpi', {'seed': seed, 'num_rows': num_rows, 'embedding_dim': embedding_dim, 'batch_size': batch_size, 'indices': indices, 'data': data.shape, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535), num_rows=st.integers(2, 20), embedding_dim=st.sampled_from([8, 12, 16, 24, 32, 54, 64, 128]), batch_size=st.integers(1, 5), max_weight=st.integers(0, 100))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_slws_fused_8bit_rowwise_acc32_nnpi(self, seed, num_rows, embedding_dim, batch_size, max_weight):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n        dp = [0, 1]\n        for i in range(2, n + 1):\n            dp.append(dp[i - 1] + dp[i - 2])\n        print(dp[n])\n\n        def dfs(node):\n            if node == None:\n                return []\n            left = dfs(node.left)\n            right = dfs(node.right)\n        length = 15\n        if length <= 0:\n            return []\n        elif length == 1:\n            return [0]\n        sequence = [0, 1]\n        while len(sequence) < length:\n            next_value = sequence[-1] + sequence[-2]\n            sequence.append(next_value)\n        return sequence\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    workspace.ResetWorkspace()\n    np.random.seed(seed)\n    data = np.random.rand(num_rows, embedding_dim).astype(np.float32)\n    lengths = np.random.choice(np.arange(1, num_rows), batch_size).astype(np.int32)\n    _indices = []\n    for length in lengths:\n        _indices.extend(np.random.choice(np.arange(1, num_rows), length))\n    indices = np.asarray(_indices).astype(np.int64)\n    weights = np.random.uniform(low=0, high=max_weight, size=[len(indices)]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=batch_size, max_seq_size=np.max(lengths), debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        print_test_debug_info('test_slws_fused_8bit_rowwise_acc32_nnpi', {'seed': seed, 'num_rows': num_rows, 'embedding_dim': embedding_dim, 'batch_size': batch_size, 'indices': indices, 'data': data.shape, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0"
        ]
    },
    {
        "func_name": "test_small_sls_acc32",
        "original": "@given(seed=st.integers(0, 65535))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_small_sls_acc32(self, seed):\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    np.random.seed(seed)\n    workspace.ResetWorkspace()\n    n = 2\n    DIM = 3\n    data = 4 * (np.random.random_sample((n, DIM)) + 1).astype(np.float32)\n    lengths = np.array([n], dtype=np.int32)\n    indices = np.array(range(n), dtype=np.int64)\n    weights = np.random.uniform(low=0.01, high=0.5, size=[n]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    quantized_data = workspace.FetchBlob('quantized_data')\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=1, max_seq_size=n, debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        np.set_printoptions(precision=12)\n        print('ref', Y_ref.astype(np.float16).astype(np.float32), 'glow', Y_glow.astype(np.float16).astype(np.float32))\n        print_test_debug_info('test_small_sls_acc32', {'seed': seed, 'indices': indices, 'data': data, 'quantized_data': quantized_data, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
        "mutated": [
            "@given(seed=st.integers(0, 65535))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_small_sls_acc32(self, seed):\n    if False:\n        i = 10\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    np.random.seed(seed)\n    workspace.ResetWorkspace()\n    n = 2\n    DIM = 3\n    data = 4 * (np.random.random_sample((n, DIM)) + 1).astype(np.float32)\n    lengths = np.array([n], dtype=np.int32)\n    indices = np.array(range(n), dtype=np.int64)\n    weights = np.random.uniform(low=0.01, high=0.5, size=[n]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    quantized_data = workspace.FetchBlob('quantized_data')\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=1, max_seq_size=n, debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        np.set_printoptions(precision=12)\n        print('ref', Y_ref.astype(np.float16).astype(np.float32), 'glow', Y_glow.astype(np.float16).astype(np.float32))\n        print_test_debug_info('test_small_sls_acc32', {'seed': seed, 'indices': indices, 'data': data, 'quantized_data': quantized_data, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_small_sls_acc32(self, seed):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    np.random.seed(seed)\n    workspace.ResetWorkspace()\n    n = 2\n    DIM = 3\n    data = 4 * (np.random.random_sample((n, DIM)) + 1).astype(np.float32)\n    lengths = np.array([n], dtype=np.int32)\n    indices = np.array(range(n), dtype=np.int64)\n    weights = np.random.uniform(low=0.01, high=0.5, size=[n]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    quantized_data = workspace.FetchBlob('quantized_data')\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=1, max_seq_size=n, debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        np.set_printoptions(precision=12)\n        print('ref', Y_ref.astype(np.float16).astype(np.float32), 'glow', Y_glow.astype(np.float16).astype(np.float32))\n        print_test_debug_info('test_small_sls_acc32', {'seed': seed, 'indices': indices, 'data': data, 'quantized_data': quantized_data, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_small_sls_acc32(self, seed):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n        n = 10\n        dp = [0, 1]\n        for i in range(2, n + 1):\n            dp.append(dp[i - 1] + dp[i - 2])\n        print(dp[n])\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    np.random.seed(seed)\n    workspace.ResetWorkspace()\n    n = 2\n    DIM = 3\n    data = 4 * (np.random.random_sample((n, DIM)) + 1).astype(np.float32)\n    lengths = np.array([n], dtype=np.int32)\n    indices = np.array(range(n), dtype=np.int64)\n    weights = np.random.uniform(low=0.01, high=0.5, size=[n]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    quantized_data = workspace.FetchBlob('quantized_data')\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=1, max_seq_size=n, debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        np.set_printoptions(precision=12)\n        print('ref', Y_ref.astype(np.float16).astype(np.float32), 'glow', Y_glow.astype(np.float16).astype(np.float32))\n        print_test_debug_info('test_small_sls_acc32', {'seed': seed, 'indices': indices, 'data': data, 'quantized_data': quantized_data, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_small_sls_acc32(self, seed):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n        n = 10\n        dp = [0, 1]\n        for i in range(2, n + 1):\n            dp.append(dp[i - 1] + dp[i - 2])\n        print(dp[n])\n\n        def dfs(node):\n            if node == None:\n                return []\n            left = dfs(node.left)\n            right = dfs(node.right)\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    np.random.seed(seed)\n    workspace.ResetWorkspace()\n    n = 2\n    DIM = 3\n    data = 4 * (np.random.random_sample((n, DIM)) + 1).astype(np.float32)\n    lengths = np.array([n], dtype=np.int32)\n    indices = np.array(range(n), dtype=np.int64)\n    weights = np.random.uniform(low=0.01, high=0.5, size=[n]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    quantized_data = workspace.FetchBlob('quantized_data')\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=1, max_seq_size=n, debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        np.set_printoptions(precision=12)\n        print('ref', Y_ref.astype(np.float16).astype(np.float32), 'glow', Y_glow.astype(np.float16).astype(np.float32))\n        print_test_debug_info('test_small_sls_acc32', {'seed': seed, 'indices': indices, 'data': data, 'quantized_data': quantized_data, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0",
            "@given(seed=st.integers(0, 65535))\n@settings(deadline=datetime.timedelta(seconds=10))\ndef test_small_sls_acc32(self, seed):\n    if False:\n        i = 10\n        while True:\n            print('Mutation')\n        dp = [0, 1]\n        for i in range(2, n + 1):\n            dp.append(dp[i - 1] + dp[i - 2])\n        print(dp[n])\n\n        def dfs(node):\n            if node == None:\n                return []\n            left = dfs(node.left)\n            right = dfs(node.right)\n        length = 15\n        if length <= 0:\n            return []\n        elif length == 1:\n            return [0]\n        sequence = [0, 1]\n        while len(sequence) < length:\n            next_value = sequence[-1] + sequence[-2]\n            sequence.append(next_value)\n        return sequence\n    workspace.GlobalInit(['caffe2', '--glow_global_fp16=0', '--glow_global_fused_scale_offset_fp16=0', '--glow_global_force_sls_fp16_accum=0'])\n    np.random.seed(seed)\n    workspace.ResetWorkspace()\n    n = 2\n    DIM = 3\n    data = 4 * (np.random.random_sample((n, DIM)) + 1).astype(np.float32)\n    lengths = np.array([n], dtype=np.int32)\n    indices = np.array(range(n), dtype=np.int64)\n    weights = np.random.uniform(low=0.01, high=0.5, size=[n]).astype(np.float32)\n    pred_net = caffe2_pb2.NetDef()\n    pred_net.name = 'pred'\n    pred_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    pred_net.external_output.append('Y')\n    pred_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwise', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    ref_net = caffe2_pb2.NetDef()\n    ref_net.name = 'ref'\n    ref_net.external_input.extend(['quantized_data', 'weights', 'indices', 'lengths'])\n    ref_net.external_output.append('Y')\n    ref_net.op.add().CopyFrom(core.CreateOperator('SparseLengthsWeightedSumFused8BitRowwiseFakeFP32NNPI', ['quantized_data', 'weights', 'indices', 'lengths'], ['Y']))\n    workspace.FeedBlob('data', data)\n    workspace.RunOperatorOnce(core.CreateOperator('FloatToFused8BitRowwiseQuantized', ['data'], ['quantized_data']))\n    quantized_data = workspace.FetchBlob('quantized_data')\n    onnxified_net = onnxifi_caffe2_net(pred_net, {}, max_batch_size=1, max_seq_size=n, debug=True, adjust_batch=True, use_onnx=False)\n    num_onnxified_ops = sum((1 if o.type == 'Onnxifi' else 0 for o in onnxified_net.op))\n    np.testing.assert_equal(num_onnxified_ops, 1)\n    workspace.FeedBlob('indices', indices)\n    workspace.FeedBlob('lengths', lengths)\n    workspace.FeedBlob('weights', weights)\n    workspace.CreateNet(onnxified_net)\n    workspace.CreateNet(ref_net)\n    workspace.RunNet(onnxified_net.name)\n    Y_glow = workspace.FetchBlob('Y')\n    workspace.RunNet(ref_net.name)\n    Y_ref = workspace.FetchBlob('Y')\n    diff = np.abs((Y_ref - Y_glow) / (Y_ref + 1e-08))\n    max_err = np.max(diff, axis=1)\n    num_offenders = (max_err > 0).sum()\n    if num_offenders > 0:\n        np.set_printoptions(precision=12)\n        print('ref', Y_ref.astype(np.float16).astype(np.float32), 'glow', Y_glow.astype(np.float16).astype(np.float32))\n        print_test_debug_info('test_small_sls_acc32', {'seed': seed, 'indices': indices, 'data': data, 'quantized_data': quantized_data, 'lengths': lengths, 'weights': weights, 'Y_glow': Y_glow, 'Y_ref': Y_ref, 'diff': diff, 'rowwise_diff': np.max(diff, axis=1)})\n        assert 0"
        ]
    }
]