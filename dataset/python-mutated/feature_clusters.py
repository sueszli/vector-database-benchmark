"""
This module creates clustered subsets of features described in the paper Clustered Feature Importance (Presentation
Slides) by Dr. Marcos Lopez de Prado. https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3517595 and is also explained
in the book Machine Learning for Asset Managers Snippet 6.5.2 page 84.
"""
import numpy as np
import pandas as pd
import statsmodels.api as sm
from scipy.spatial.distance import squareform
from scipy.cluster.hierarchy import linkage, fcluster
from statsmodels.regression.linear_model import OLS
from mlfinlab.clustering.onc import get_onc_clusters
from mlfinlab.codependence.codependence_matrix import get_dependence_matrix, get_distance_matrix

def get_feature_clusters(X: pd.DataFrame, dependence_metric: str, distance_metric: str=None, linkage_method: str=None, n_clusters: int=None, critical_threshold: float=0.0) -> list:
    if False:
        for i in range(10):
            print('nop')
    "\n    Machine Learning for Asset Managers\n    Snippet 6.5.2.1 , page 85. Step 1: Features Clustering\n\n    Gets clustered features subsets from the given set of features.\n\n    :param X: (pd.DataFrame) Dataframe of features.\n    :param dependence_metric: (str) Method to be use for generating dependence_matrix, either 'linear' or\n                              'information_variation' or 'mutual_information' or 'distance_correlation'.\n    :param distance_metric: (str) The distance operator to be used for generating the distance matrix. The methods that\n                            can be applied are: 'angular', 'squared_angular', 'absolute_angular'. Set it to None if the\n                            feature are to be generated as it is by the ONC algorithm.\n    :param linkage_method: (str) Method of linkage to be used for clustering. Methods include: 'single', 'ward',\n                           'complete', 'average', 'weighted', and 'centroid'. Set it to None if the feature are to\n                           be generated as it is by the ONC algorithm.\n    :param n_clusters: (int) Number of clusters to form. Must be less the total number of features. If None then it\n                       returns optimal number of clusters decided by the ONC Algorithm.\n    :param critical_threshold: (float) Threshold for determining low silhouette score in the dataset. It can any real number\n                                in [-1,+1], default is 0 which means any feature that has a silhouette score below 0 will be\n                                indentified as having low silhouette and hence requied transformation will be appiled to for\n                                for correction of the same.\n    :return: (list) Feature subsets.\n    "
    pass

def _cluster_transformation(X: pd.DataFrame, clusters: dict, feats_to_transform: list) -> pd.DataFrame:
    if False:
        i = 10
        return i + 15
    '\n    Machine Learning for Asset Managers\n    Snippet 6.5.2.1 , page 85. Step 1: Features Clustering (last paragraph)\n\n    Transforms a dataset to reduce the multicollinearity of the system by replacing the original feature with\n    the residual from regression.\n\n    :param X: (pd.DataFrame) Dataframe of features.\n    :param clusters: (dict) Clusters generated by ONC algorithm.\n    :param feats_to_transform: (list) Features that have low silhouette score and to be transformed.\n    :return: (pd.DataFrame) Transformed features.\n    '
    pass

def _combine_features(X, clusters, exclude_key) -> np.array:
    if False:
        for i in range(10):
            print('nop')
    '\n    Combines features of each cluster linearly by following a minimum variance weighting scheme.\n    The Minimum Variance weights are calculated without constraints, other than the weights sum to one.\n\n    :param X: (pd.DataFrame) Dataframe of features.\n    :param clusters: (dict) Clusters generated by ONC algorithm.\n    :param exclude_key: (int) Key of the cluster which is to be excluded.\n    :return: (np.array) Combined features for each cluster.\n    '
    pass

def _check_for_low_silhouette_scores(X: pd.DataFrame, dep_matrix: pd.DataFrame, critical_threshold: float=0.0) -> pd.DataFrame:
    if False:
        i = 10
        return i + 15
    '\n    Machine Learning for Asset Managers\n    Snippet 6.5.2.1 , page 85. Step 1: Features Clustering (last paragraph)\n\n    Checks where the dataset contains features low silhouette due one feature being a combination of\n    multiple features across clusters. This is a problem, because ONC cannot assign one feature to multiple\n    clusters and it needs a transformation.\n\n    :param X: (pd.DataFrame) Dataframe of features.\n    :param dep_matrix: (pd.DataFrame) Dataframe with dependences between features.\n    :param critical_threshold: (float) Threshold for determining low silhouette score.\n    :return: (pd.DataFrame) Dataframe of features.\n    '
    pass