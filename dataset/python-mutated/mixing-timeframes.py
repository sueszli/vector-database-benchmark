from __future__ import absolute_import, division, print_function, unicode_literals
import argparse
import backtrader as bt
import backtrader.feeds as btfeeds
import backtrader.indicators as btind
import backtrader.utils.flushfile

class St(bt.Strategy):
    params = dict(multi=True)

    def __init__(self):
        if False:
            return 10
        self.pp = pp = btind.PivotPoint(self.data1)
        pp.plotinfo.plot = False
        if self.p.multi:
            pp1 = pp()
            self.sellsignal = self.data0.close < pp1.s1
        else:
            self.sellsignal = self.data0.close < pp.s1()

    def next(self):
        if False:
            print('Hello World!')
        txt = ','.join(['%04d' % len(self), '%04d' % len(self.data0), '%04d' % len(self.data1), self.data.datetime.date(0).isoformat(), '%.2f' % self.data0.close[0], '%.2f' % self.pp.s1[0], '%.2f' % self.sellsignal[0]])
        print(txt)

def runstrat():
    if False:
        i = 10
        return i + 15
    args = parse_args()
    cerebro = bt.Cerebro()
    data = btfeeds.BacktraderCSVData(dataname=args.data)
    cerebro.adddata(data)
    cerebro.resampledata(data, timeframe=bt.TimeFrame.Months)
    cerebro.addstrategy(St, multi=args.multi)
    cerebro.run(stdstats=False, runonce=False)
    if args.plot:
        cerebro.plot(style='bar')

def parse_args():
    if False:
        return 10
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter, description='Sample for pivot point and cross plotting')
    parser.add_argument('--data', required=False, default='../../datas/2005-2006-day-001.txt', help='Data to be read in')
    parser.add_argument('--multi', required=False, action='store_true', help='Couple all lines of the indicator')
    parser.add_argument('--plot', required=False, action='store_true', help='Plot the result')
    return parser.parse_args()
if __name__ == '__main__':
    runstrat()