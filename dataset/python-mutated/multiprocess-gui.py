"""
Created on 2019-05-01

@author: yinkaisheng@live.com
@copyright: 2019 yinkaisheng@live.com
@license: GNU AFFERO GPL 3.0

Demonstrate the use of multiprocessing with PyMuPDF
-----------------------------------------------------
This example shows some more advanced use of multiprocessing.
The main process show a Qt GUI and establishes a 2-way communication with
another process, which accesses a supported document.
"""
import os
import sys
import time
import multiprocessing as mp
import queue
import fitz
' PyQt and PySide namespace unifier shim\n    https://www.pythonguis.com/faq/pyqt6-vs-pyside6/\n    simple "if \'PyQt6\' in sys.modules:" test fails for me, so the more complex pkgutil use\n    overkill for most people who might have one or the other, why both?\n'
from pkgutil import iter_modules

def module_exists(module_name):
    if False:
        i = 10
        return i + 15
    return module_name in (name for (loader, name, ispkg) in iter_modules())
if module_exists('PyQt6'):
    from PyQt6 import QtGui, QtWidgets, QtCore
    from PyQt6.QtCore import pyqtSignal as Signal, pyqtSlot as Slot
    wrapper = 'PyQt6'
elif module_exists('PySide6'):
    from PySide6 import QtGui, QtWidgets, QtCore
    from PySide6.QtCore import Signal, Slot
    wrapper = 'PySide6'
my_timer = time.clock if str is bytes else time.perf_counter

class DocForm(QtWidgets.QWidget):

    def __init__(self):
        if False:
            print('Hello World!')
        super().__init__()
        self.process = None
        self.queNum = mp.Queue()
        self.queDoc = mp.Queue()
        self.page_count = 0
        self.curPageNum = 0
        self.lastDir = ''
        self.timerSend = QtCore.QTimer(self)
        self.timerSend.timeout.connect(self.onTimerSendPageNum)
        self.timerGet = QtCore.QTimer(self)
        self.timerGet.timeout.connect(self.onTimerGetPage)
        self.timerWaiting = QtCore.QTimer(self)
        self.timerWaiting.timeout.connect(self.onTimerWaiting)
        self.initUI()

    def initUI(self):
        if False:
            while True:
                i = 10
        vbox = QtWidgets.QVBoxLayout()
        self.setLayout(vbox)
        hbox = QtWidgets.QHBoxLayout()
        self.btnOpen = QtWidgets.QPushButton('OpenDocument', self)
        self.btnOpen.clicked.connect(self.openDoc)
        hbox.addWidget(self.btnOpen)
        self.btnPlay = QtWidgets.QPushButton('PlayDocument', self)
        self.btnPlay.clicked.connect(self.playDoc)
        hbox.addWidget(self.btnPlay)
        self.btnStop = QtWidgets.QPushButton('Stop', self)
        self.btnStop.clicked.connect(self.stopPlay)
        hbox.addWidget(self.btnStop)
        self.label = QtWidgets.QLabel('0/0', self)
        self.label.setFont(QtGui.QFont('Verdana', 20))
        hbox.addWidget(self.label)
        vbox.addLayout(hbox)
        self.labelImg = QtWidgets.QLabel('Document', self)
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Preferred, QtWidgets.QSizePolicy.Policy.Expanding)
        self.labelImg.setSizePolicy(sizePolicy)
        vbox.addWidget(self.labelImg)
        self.setGeometry(100, 100, 400, 600)
        self.setWindowTitle('PyMuPDF Document Player')
        self.show()

    def openDoc(self):
        if False:
            for i in range(10):
                print('nop')
        (path, _) = QtWidgets.QFileDialog.getOpenFileName(self, 'Open Document', self.lastDir, 'All Supported Files (*.pdf;*.epub;*.xps;*.oxps;*.cbz;*.fb2);;PDF Files (*.pdf);;EPUB Files (*.epub);;XPS Files (*.xps);;OpenXPS Files (*.oxps);;CBZ Files (*.cbz);;FB2 Files (*.fb2)')
        if path:
            (self.lastDir, self.file) = os.path.split(path)
            if self.process:
                self.queNum.put(-1)
            self.timerSend.stop()
            self.curPageNum = 0
            self.page_count = 0
            self.process = mp.Process(target=openDocInProcess, args=(path, self.queNum, self.queDoc))
            self.process.start()
            self.timerGet.start(40)
            self.label.setText('0/0')
            self.queNum.put(0)
            self.startTime = time.perf_counter()
            self.timerWaiting.start(40)

    def playDoc(self):
        if False:
            return 10
        self.timerSend.start(500)

    def stopPlay(self):
        if False:
            print('Hello World!')
        self.timerSend.stop()

    def onTimerSendPageNum(self):
        if False:
            i = 10
            return i + 15
        if self.curPageNum < self.page_count - 1:
            self.queNum.put(self.curPageNum + 1)
        else:
            self.timerSend.stop()

    def onTimerGetPage(self):
        if False:
            for i in range(10):
                print('nop')
        try:
            ret = self.queDoc.get(False)
            if isinstance(ret, int):
                self.timerWaiting.stop()
                self.page_count = ret
                self.label.setText('{}/{}'.format(self.curPageNum + 1, self.page_count))
            else:
                (num, samples, width, height, stride, alpha) = ret
                self.curPageNum = num
                self.label.setText('{}/{}'.format(self.curPageNum + 1, self.page_count))
                fmt = QtGui.QImage.Format.Format_RGBA8888 if alpha else QtGui.QImage.Format.Format_RGB888
                qimg = QtGui.QImage(samples, width, height, stride, fmt)
                self.labelImg.setPixmap(QtGui.QPixmap.fromImage(qimg))
        except queue.Empty as ex:
            pass

    def onTimerWaiting(self):
        if False:
            return 10
        self.labelImg.setText('Loading "{}", {:.2f}s'.format(self.file, time.perf_counter() - self.startTime))

    def closeEvent(self, event):
        if False:
            i = 10
            return i + 15
        self.queNum.put(-1)
        event.accept()

def openDocInProcess(path, queNum, quePageInfo):
    if False:
        while True:
            i = 10
    start = my_timer()
    doc = fitz.open(path)
    end = my_timer()
    quePageInfo.put(doc.page_count)
    while True:
        num = queNum.get()
        if num < 0:
            break
        page = doc.load_page(num)
        pix = page.get_pixmap()
        quePageInfo.put((num, pix.samples, pix.width, pix.height, pix.stride, pix.alpha))
    doc.close()
    print('process exit')
if __name__ == '__main__':
    app = QtWidgets.QApplication(sys.argv)
    form = DocForm()
    sys.exit(app.exec())